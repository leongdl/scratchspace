# ComfyUI with WanVideo 2.1 T2V 1.3B pre-baked
# Build: docker build -f Dockerfile.wanvideo-1.3b -t comfyui-wanvideo-1.3b:latest .
# Requires: comfyui-sdxl:latest base image
# VRAM: ~8GB inference (runs on consumer GPUs like RTX 4090, or cloud L4/A10G)

FROM comfyui-sdxl:latest

USER root

# Create required model directories
RUN mkdir -p \
    /opt/comfyui/models/diffusion_models \
    /opt/comfyui/models/text_encoders

# Install ComfyUI-WanVideoWrapper custom node
RUN git clone --depth 1 https://github.com/kijai/ComfyUI-WanVideoWrapper.git \
    /opt/comfyui/custom_nodes/ComfyUI-WanVideoWrapper && \
    chown -R comfyui:comfyui /opt/comfyui/custom_nodes/ComfyUI-WanVideoWrapper

# Install ComfyUI-VideoHelperSuite for MP4/video output
RUN git clone --depth 1 https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git \
    /opt/comfyui/custom_nodes/ComfyUI-VideoHelperSuite && \
    chown -R comfyui:comfyui /opt/comfyui/custom_nodes/ComfyUI-VideoHelperSuite

USER comfyui
RUN pip install --user -r /opt/comfyui/custom_nodes/ComfyUI-WanVideoWrapper/requirements.txt && \
    pip install --user -r /opt/comfyui/custom_nodes/ComfyUI-VideoHelperSuite/requirements.txt

USER root

# Bake Wan 2.1 T2V 1.3B fp16 diffusion model (~2.6GB)
# Source: https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged
# Much smaller than 14B (~28GB) — trades quality for speed and lower VRAM
RUN wget -q --show-progress -O /opt/comfyui/models/diffusion_models/wan2.1_t2v_1.3B_fp16.safetensors \
    "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/main/split_files/diffusion_models/wan2.1_t2v_1.3B_fp16.safetensors"

# Bake Wan 2.1 VAE (~300MB) — same VAE as 14B
RUN wget -q --show-progress -O /opt/comfyui/models/vae/wan_2.1_vae.safetensors \
    "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/main/split_files/vae/wan_2.1_vae.safetensors"

# Bake UMT5-XXL fp16 text encoder (~9.5GB) — same text encoder as 14B
RUN wget -q --show-progress -O /opt/comfyui/models/text_encoders/umt5_xxl_fp16.safetensors \
    "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/main/split_files/text_encoders/umt5_xxl_fp16.safetensors"

# Bake TAESD Wan 2.1 preview model (~5MB) for fast previews during sampling
RUN wget -q --show-progress -O /opt/comfyui/models/vae_approx/taew2_1.safetensors \
    "https://huggingface.co/Kijai/WanVideo_comfy/resolve/main/taew2_1.safetensors"

# Set proper ownership
RUN chown -R comfyui:comfyui /opt/comfyui/models /opt/comfyui/custom_nodes

USER comfyui

ENV PREVIEW_METHOD=taesd
# --disable-smart-memory not strictly needed for 1.3B (model fits easily in RAM)
# but kept for consistency with 14B variant
ENV EXTRA_ARGS="--disable-smart-memory"
